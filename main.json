{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "5930031328694193793"
    }
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "cloudpi",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Project or application name for resource naming (e.g., cloudpi, myapp)"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": {
        "description": "The environment name (e.g., prod, dev, staging)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Primary Azure region for resources"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Application": "[parameters('projectName')]",
        "Environment": "[parameters('environment')]",
        "ManagedBy": "Bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Virtual Network address space (optional - auto-assigned based on environment if not specified)"
      }
    },
    "appSubnetPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Application subnet address prefix (optional - auto-assigned based on environment if not specified)"
      }
    },
    "sshAllowedSourceAddresses": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Allowed IP ranges for SSH access (management subnet or jump host)"
      }
    },
    "httpsAllowedSourceAddresses": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Allowed IP ranges for HTTPS access (Netskope connector or corporate ranges)"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v5",
      "allowedValues": [
        "Standard_D2s_v3",
        "Standard_D4s_v3",
        "Standard_D8s_v3",
        "Standard_D2s_v4",
        "Standard_D4s_v4",
        "Standard_D8s_v4",
        "Standard_D2s_v5",
        "Standard_D4s_v5",
        "Standard_D8s_v5",
        "Standard_D2as_v4",
        "Standard_D4as_v4",
        "Standard_D8as_v4",
        "Standard_D2as_v5",
        "Standard_D4as_v5",
        "Standard_D8as_v5"
      ],
      "metadata": {
        "description": "VM size for the CloudPi application server"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureadmin",
      "metadata": {
        "description": "Admin username for the VM"
      }
    },
    "sshPublicKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH public key for VM access"
      }
    },
    "osDiskSizeGB": {
      "type": "int",
      "defaultValue": 128,
      "metadata": {
        "description": "OS disk size in GB"
      }
    },
    "dataDiskSizeGB": {
      "type": "int",
      "defaultValue": 256,
      "metadata": {
        "description": "Data disk size in GB"
      }
    },
    "enableBackup": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Azure Backup for the VM"
      }
    },
    "backupRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Backup retention in days"
      }
    },
    "alertEmailAddresses": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Email addresses for alert notifications"
      }
    },
    "tenantId": {
      "type": "string",
      "metadata": {
        "description": "Your Azure AD Tenant ID"
      }
    },
    "enableAutoShutdown": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable auto-shutdown schedule for VM (recommended for dev/test)"
      }
    },
    "autoShutdownTime": {
      "type": "string",
      "defaultValue": "2200",
      "metadata": {
        "description": "Auto-shutdown time in 24-hour format (e.g., 2200 for 10 PM)"
      }
    },
    "autoShutdownTimeZone": {
      "type": "string",
      "defaultValue": "UTC",
      "metadata": {
        "description": "Timezone for auto-shutdown (e.g., Eastern Standard Time, Pacific Standard Time, Central Standard Time)"
      }
    },
    "autoShutdownNotificationEmail": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Email notification for auto-shutdown (optional)"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[format('rg-{0}-{1}', parameters('projectName'), parameters('environment'))]",
    "namingPrefix": "[parameters('projectName')]",
    "hashString": "[uniqueString(parameters('projectName'), parameters('environment'))]",
    "hashValue": "[add(add(mul(length(variables('hashString')), 17), mul(length(parameters('projectName')), 13)), mul(length(parameters('environment')), 7))]",
    "calculateIpOctet": "[string(add(mod(variables('hashValue'), 200), 50))]",
    "autoVnetPrefix": "[format('10.{0}.0.0/16', variables('calculateIpOctet'))]",
    "autoAppSubnetPrefix": "[format('10.{0}.1.0/24', variables('calculateIpOctet'))]",
    "actualVnetAddressPrefix": "[if(not(empty(parameters('vnetAddressPrefix'))), parameters('vnetAddressPrefix'), variables('autoVnetPrefix'))]",
    "actualAppSubnetPrefix": "[if(not(empty(parameters('appSubnetPrefix'))), parameters('appSubnetPrefix'), variables('autoAppSubnetPrefix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "networking-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('actualVnetAddressPrefix')]"
          },
          "appSubnetPrefix": {
            "value": "[variables('actualAppSubnetPrefix')]"
          },
          "sshAllowedSourceAddresses": {
            "value": "[parameters('sshAllowedSourceAddresses')]"
          },
          "httpsAllowedSourceAddresses": {
            "value": "[parameters('httpsAllowedSourceAddresses')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17979395121950180630"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Project name for resource naming"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network address space"
              }
            },
            "appSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Application subnet address prefix"
              }
            },
            "sshAllowedSourceAddresses": {
              "type": "array",
              "metadata": {
                "description": "Allowed IP ranges for SSH access"
              }
            },
            "httpsAllowedSourceAddresses": {
              "type": "array",
              "metadata": {
                "description": "Allowed IP ranges for HTTPS access"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}-spoke-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "appSubnetName": "[format('snet-{0}-app-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "nsgName": "[format('nsg-{0}-app-{1}', parameters('namingPrefix'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-HTTPS-Inbound",
                    "properties": {
                      "description": "Allow HTTPS from Netskope or corporate ranges",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "[if(and(not(empty(parameters('httpsAllowedSourceAddresses'))), equals(length(parameters('httpsAllowedSourceAddresses')), 1)), parameters('httpsAllowedSourceAddresses')[0], '*')]",
                      "sourceAddressPrefixes": "[if(and(not(empty(parameters('httpsAllowedSourceAddresses'))), greater(length(parameters('httpsAllowedSourceAddresses')), 1)), parameters('httpsAllowedSourceAddresses'), null())]",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-SSH-Inbound",
                    "properties": {
                      "description": "Allow SSH from management subnet or jump host",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[if(and(not(empty(parameters('sshAllowedSourceAddresses'))), equals(length(parameters('sshAllowedSourceAddresses')), 1)), parameters('sshAllowedSourceAddresses')[0], '*')]",
                      "sourceAddressPrefixes": "[if(and(not(empty(parameters('sshAllowedSourceAddresses'))), greater(length(parameters('sshAllowedSourceAddresses')), 1)), parameters('sshAllowedSourceAddresses'), null())]",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4096,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-HTTPS-Outbound",
                    "properties": {
                      "description": "Allow HTTPS outbound for Azure services and updates",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Allow-HTTP-Outbound",
                    "properties": {
                      "description": "Allow HTTP outbound for package updates",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Allow-AzureStorage-Outbound",
                    "properties": {
                      "description": "Allow access to Azure Storage",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Storage",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Allow-AzureMonitor-Outbound",
                    "properties": {
                      "description": "Allow access to Azure Monitor",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureMonitor",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Allow-VNet-Outbound",
                    "properties": {
                      "description": "Allow communication within VNet",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 140,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('appSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('appSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              },
              "value": "[variables('vnetName')]"
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the virtual network"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "appSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the app subnet"
              },
              "value": "[variables('appSubnetName')]"
            },
            "appSubnetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the app subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-05-01').subnets[0].id]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the NSG"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "The name of the NSG"
              },
              "value": "[variables('nsgName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "870451118540547448"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            }
          },
          "variables": {
            "storageAccountName": "[replace(format('st{0}apps', parameters('namingPrefix')), '-', '')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "accessTier": "Hot",
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'billing-exports')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'mysql-backups')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'app-data')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/managementPolicies",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "policy": {
                  "rules": [
                    {
                      "enabled": true,
                      "name": "expire-old-mysql-backups",
                      "type": "Lifecycle",
                      "definition": {
                        "filters": {
                          "blobTypes": [
                            "blockBlob"
                          ],
                          "prefixMatch": [
                            "mysql-backups/"
                          ]
                        },
                        "actions": {
                          "baseBlob": {
                            "tierToCool": {
                              "daysAfterModificationGreaterThan": 30
                            },
                            "delete": {
                              "daysAfterModificationGreaterThan": 90
                            }
                          }
                        }
                      }
                    },
                    {
                      "enabled": true,
                      "name": "expire-old-billing-exports",
                      "type": "Lifecycle",
                      "definition": {
                        "filters": {
                          "blobTypes": [
                            "blockBlob"
                          ],
                          "prefixMatch": [
                            "billing-exports/"
                          ]
                        },
                        "actions": {
                          "baseBlob": {
                            "tierToCool": {
                              "daysAfterModificationGreaterThan": 90
                            },
                            "delete": {
                              "daysAfterModificationGreaterThan": 365
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              },
              "value": "[variables('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the storage account"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "storageAccountPrimaryEndpoints": {
              "type": "object",
              "metadata": {
                "description": "The primary endpoints for the storage account"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints]"
            },
            "billingExportsContainerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the billing exports container"
              },
              "value": "billing-exports"
            },
            "backupsContainerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the MySQL backups container"
              },
              "value": "mysql-backups"
            },
            "appDataContainerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the app data container"
              },
              "value": "app-data"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "security-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16617800237394024417"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Project name for resource naming"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            }
          },
          "variables": {
            "uniqueSuffix": "[take(uniqueString(subscription().subscriptionId, parameters('namingPrefix'), parameters('environment')), 6)]",
            "keyVaultName": "[format('kv-{0}-{1}-{2}', parameters('namingPrefix'), parameters('environment'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enableRbacAuthorization": true,
                "enablePurgeProtection": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              },
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Key Vault"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "alertEmailAddresses": {
            "value": "[parameters('alertEmailAddresses')]"
          },
          "enableBackup": {
            "value": "[parameters('enableBackup')]"
          },
          "backupRetentionDays": {
            "value": "[parameters('backupRetentionDays')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5185541635878481914"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Project name for resource naming"
              }
            },
            "alertEmailAddresses": {
              "type": "array",
              "metadata": {
                "description": "Email addresses for alert notifications"
              }
            },
            "enableBackup": {
              "type": "bool",
              "metadata": {
                "description": "Enable Azure Backup"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "metadata": {
                "description": "Backup retention in days"
              }
            }
          },
          "variables": {
            "logAnalyticsWorkspaceName": "[format('law-{0}-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "actionGroupName": "[format('ag-{0}-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "recoveryServicesVaultName": "[format('rsv-{0}-{1}', parameters('namingPrefix'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                }
              }
            },
            {
              "condition": "[not(empty(parameters('alertEmailAddresses')))]",
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "[variables('actionGroupName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "emailReceivers",
                    "count": "[length(parameters('alertEmailAddresses'))]",
                    "input": {
                      "name": "[format('email-{0}', copyIndex('emailReceivers'))]",
                      "emailAddress": "[parameters('alertEmailAddresses')[copyIndex('emailReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  }
                ],
                "groupShortName": "[take(format('{0}-{1}', parameters('namingPrefix'), parameters('environment')), 12)]",
                "enabled": true
              }
            },
            {
              "condition": "[parameters('enableBackup')]",
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2024-01-01",
              "name": "[variables('recoveryServicesVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "RS0",
                "tier": "Standard"
              },
              "properties": {
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "condition": "[parameters('enableBackup')]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('recoveryServicesVaultName'), 'DailyBackupPolicy')]",
              "properties": {
                "backupManagementType": "AzureIaasVM",
                "instantRpRetentionRangeInDays": 2,
                "schedulePolicy": {
                  "schedulePolicyType": "SimpleSchedulePolicy",
                  "scheduleRunFrequency": "Daily",
                  "scheduleRunTimes": [
                    "2024-01-01T02:00:00Z"
                  ],
                  "scheduleWeeklyFrequency": 0
                },
                "retentionPolicy": {
                  "retentionPolicyType": "LongTermRetentionPolicy",
                  "dailySchedule": {
                    "retentionTimes": [
                      "2024-01-01T02:00:00Z"
                    ],
                    "retentionDuration": {
                      "count": "[parameters('backupRetentionDays')]",
                      "durationType": "Days"
                    }
                  }
                },
                "timeZone": "UTC"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', variables('recoveryServicesVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics workspace"
              },
              "value": "[variables('logAnalyticsWorkspaceName')]"
            },
            "logAnalyticsWorkspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "The workspace ID (customer ID) for agents"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
            },
            "actionGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the action group"
              },
              "value": "[if(not(empty(parameters('alertEmailAddresses'))), resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName')), '')]"
            },
            "actionGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the action group"
              },
              "value": "[if(not(empty(parameters('alertEmailAddresses'))), variables('actionGroupName'), '')]"
            },
            "recoveryServicesVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Recovery Services Vault"
              },
              "value": "[if(parameters('enableBackup'), variables('recoveryServicesVaultName'), '')]"
            },
            "recoveryServicesVaultId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Recovery Services Vault"
              },
              "value": "[if(parameters('enableBackup'), resourceId('Microsoft.RecoveryServices/vaults', variables('recoveryServicesVaultName')), '')]"
            },
            "backupPolicyName": {
              "type": "string",
              "metadata": {
                "description": "The name of the backup policy"
              },
              "value": "[if(parameters('enableBackup'), 'DailyBackupPolicy', '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "compute-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "osDiskSizeGB": {
            "value": "[parameters('osDiskSizeGB')]"
          },
          "dataDiskSizeGB": {
            "value": "[parameters('dataDiskSizeGB')]"
          },
          "subnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.appSubnetId.value]"
          },
          "nsgId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.nsgId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
          },
          "recoveryServicesVaultName": "[if(parameters('enableBackup'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.recoveryServicesVaultName.value), createObject('value', ''))]",
          "enableBackup": {
            "value": "[parameters('enableBackup')]"
          },
          "enableAutoShutdown": {
            "value": "[parameters('enableAutoShutdown')]"
          },
          "autoShutdownTime": {
            "value": "[parameters('autoShutdownTime')]"
          },
          "autoShutdownTimeZone": {
            "value": "[parameters('autoShutdownTimeZone')]"
          },
          "autoShutdownNotificationEmail": {
            "value": "[parameters('autoShutdownNotificationEmail')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5184682870084405126"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Project name for resource naming"
              }
            },
            "vmSize": {
              "type": "string",
              "metadata": {
                "description": "VM size"
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Admin username"
              }
            },
            "sshPublicKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH public key"
              }
            },
            "osDiskSizeGB": {
              "type": "int",
              "metadata": {
                "description": "OS disk size in GB"
              }
            },
            "dataDiskSizeGB": {
              "type": "int",
              "metadata": {
                "description": "Data disk size in GB"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet resource ID for the VM"
              }
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "NSG resource ID"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            },
            "recoveryServicesVaultName": {
              "type": "string",
              "metadata": {
                "description": "Recovery Services Vault name (if backup is enabled)"
              }
            },
            "enableBackup": {
              "type": "bool",
              "metadata": {
                "description": "Enable backup"
              }
            },
            "enableAutoShutdown": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable auto-shutdown schedule"
              }
            },
            "autoShutdownTime": {
              "type": "string",
              "defaultValue": "2200",
              "metadata": {
                "description": "Auto-shutdown time in 24-hour format (e.g., 2200 for 10 PM)"
              }
            },
            "autoShutdownTimeZone": {
              "type": "string",
              "defaultValue": "UTC",
              "metadata": {
                "description": "Timezone for auto-shutdown (e.g., Eastern Standard Time, Pacific Standard Time)"
              }
            },
            "autoShutdownNotificationEmail": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Email notification for auto-shutdown"
              }
            }
          },
          "variables": {
            "vmName": "[format('vm-{0}-app-01-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "nicName": "[format('nic-{0}-app-01-{1}', parameters('namingPrefix'), parameters('environment'))]",
            "osDiskName": "[format('{0}-osdisk', variables('vmName'))]",
            "dataDiskName": "[format('{0}-datadisk', variables('vmName'))]",
            "cloudInit": "[base64('#cloud-config\npackage_upgrade: true\npackages:\n  - apt-transport-https\n  - ca-certificates\n  - curl\n  - gnupg\n  - lsb-release\n\nwrite_files:\n  - path: /etc/docker/daemon.json\n    content: |\n      {\n        \"log-driver\": \"json-file\",\n        \"log-opts\": {\n          \"max-size\": \"10m\",\n          \"max-file\": \"3\"\n        }\n      }\n\nruncmd:\n  # Install Docker\n  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n  - echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null\n  - apt-get update\n  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin\n  - systemctl enable docker\n  - systemctl start docker\n  - usermod -aG docker ${adminUsername}\n\n  # Create data disk mount point\n  - mkdir -p /mnt/cloudpi-data\n\n  # Format and mount data disk (assuming it''s /dev/sdc)\n  - |\n    if [ -b /dev/sdc ]; then\n      parted /dev/sdc --script mklabel gpt mkpart primary ext4 0% 100%\n      mkfs.ext4 /dev/sdc1\n      echo ''/dev/sdc1 /mnt/cloudpi-data ext4 defaults,nofail 0 2'' >> /etc/fstab\n      mount -a\n      chown -R ${adminUsername}:${adminUsername} /mnt/cloudpi-data\n    fi\n\n  # Create directories for CloudPi\n  - mkdir -p /mnt/cloudpi-data/mysql\n  - mkdir -p /mnt/cloudpi-data/app\n  - mkdir -p /mnt/cloudpi-data/logs\n  - mkdir -p /mnt/cloudpi-data/backups\n  - chown -R ${adminUsername}:${adminUsername} /mnt/cloudpi-data\n\n  # Install Azure CLI (for potential management tasks)\n  - curl -sL https://aka.ms/InstallAzureCLIDeb | bash\n')]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('nicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic"
                    }
                  }
                ],
                "networkSecurityGroup": {
                  "id": "[parameters('nsgId')]"
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-09-01",
              "name": "[variables('vmName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[variables('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "customData": "[variables('cloudInit')]",
                  "linuxConfiguration": {
                    "disablePasswordAuthentication": true,
                    "ssh": {
                      "publicKeys": [
                        {
                          "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                          "keyData": "[parameters('sshPublicKey')]"
                        }
                      ]
                    },
                    "patchSettings": {
                      "patchMode": "AutomaticByPlatform",
                      "automaticByPlatformSettings": {
                        "rebootSetting": "IfRequired"
                      }
                    }
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "Canonical",
                    "offer": "0001-com-ubuntu-server-jammy",
                    "sku": "22_04-lts-gen2",
                    "version": "latest"
                  },
                  "osDisk": {
                    "name": "[variables('osDiskName')]",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "Premium_LRS"
                    },
                    "diskSizeGB": "[parameters('osDiskSizeGB')]",
                    "deleteOption": "Delete"
                  },
                  "dataDisks": [
                    {
                      "name": "[variables('dataDiskName')]",
                      "lun": 0,
                      "createOption": "Empty",
                      "diskSizeGB": "[parameters('dataDiskSizeGB')]",
                      "managedDisk": {
                        "storageAccountType": "Premium_LRS"
                      },
                      "deleteOption": "Delete"
                    }
                  ]
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": true
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', variables('vmName'), 'AzureMonitorLinuxAgent')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Monitor",
                "type": "AzureMonitorLinuxAgent",
                "typeHandlerVersion": "1.25",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[format('dcr-{0}-{1}', parameters('namingPrefix'), parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataSources": {
                  "performanceCounters": [
                    {
                      "name": "perfCounterDataSource",
                      "streams": [
                        "Microsoft-Perf"
                      ],
                      "samplingFrequencyInSeconds": 60,
                      "counterSpecifiers": [
                        "Processor(*)\\% Processor Time",
                        "Memory(*)\\Available MBytes",
                        "Memory(*)\\% Used Memory",
                        "Disk(*)\\% Free Space",
                        "Disk(*)\\Disk Read Bytes/sec",
                        "Disk(*)\\Disk Write Bytes/sec",
                        "Network(*)\\Total Bytes"
                      ]
                    }
                  ],
                  "syslog": [
                    {
                      "name": "syslogDataSource",
                      "streams": [
                        "Microsoft-Syslog"
                      ],
                      "facilityNames": [
                        "auth",
                        "authpriv",
                        "cron",
                        "daemon",
                        "kern",
                        "syslog"
                      ],
                      "logLevels": [
                        "Error",
                        "Critical",
                        "Alert",
                        "Emergency",
                        "Warning"
                      ]
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                      "name": "la-destination"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-Perf",
                      "Microsoft-Syslog"
                    ],
                    "destinations": [
                      "la-destination"
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', variables('vmName'))]",
              "name": "[format('dcra-{0}-{1}', parameters('namingPrefix'), parameters('environment'))]",
              "properties": {
                "dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', format('dcr-{0}-{1}', parameters('namingPrefix'), parameters('environment')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionRules', format('dcr-{0}-{1}', parameters('namingPrefix'), parameters('environment')))]",
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            },
            {
              "condition": "[and(parameters('enableBackup'), not(empty(parameters('recoveryServicesVaultName'))))]",
              "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/Azure/iaasvmcontainer;iaasvmcontainerv2;{1};{2}/vm;iaasvmcontainerv2;{3};{4}', parameters('recoveryServicesVaultName'), resourceGroup().name, variables('vmName'), resourceGroup().name, variables('vmName'))]",
              "properties": {
                "protectedItemType": "Microsoft.Compute/virtualMachines",
                "sourceResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]",
                "policyId": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('recoveryServicesVaultName'), 'DailyBackupPolicy')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            },
            {
              "condition": "[parameters('enableAutoShutdown')]",
              "type": "Microsoft.DevTestLab/schedules",
              "apiVersion": "2018-09-15",
              "name": "[format('shutdown-computevm-{0}', variables('vmName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "status": "Enabled",
                "taskType": "ComputeVmShutdownTask",
                "dailyRecurrence": {
                  "time": "[parameters('autoShutdownTime')]"
                },
                "timeZoneId": "[parameters('autoShutdownTimeZone')]",
                "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]",
                "notificationSettings": "[if(not(empty(parameters('autoShutdownNotificationEmail'))), createObject('status', 'Enabled', 'timeInMinutes', 30, 'emailRecipient', parameters('autoShutdownNotificationEmail'), 'notificationLocale', 'en'), createObject('status', 'Disabled'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            }
          ],
          "outputs": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "The name of the VM"
              },
              "value": "[variables('vmName')]"
            },
            "vmId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the VM"
              },
              "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
            },
            "vmPrivateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "The private IP address of the VM"
              },
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-05-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "vmManagedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the VM managed identity"
              },
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', variables('vmName')), '2023-09-01', 'full').identity.principalId]"
            },
            "nicName": {
              "type": "string",
              "metadata": {
                "description": "The name of the network interface"
              },
              "value": "[variables('nicName')]"
            },
            "dataCollectionRuleId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the data collection rule"
              },
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('dcr-{0}-{1}', parameters('namingPrefix'), parameters('environment')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-role-assignment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'compute-deployment'), '2025-04-01').outputs.vmManagedIdentityPrincipalId.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "2514515093722381076"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the VM managed identity"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
            "keyVaultSecretsUserRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[variables('storageBlobDataContributorRoleId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[variables('keyVaultSecretsUserRoleId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "storageRoleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "The role assignment ID for storage access"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageBlobDataContributorRoleId')))]"
            },
            "keyVaultRoleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "The role assignment ID for Key Vault access"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsUserRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'compute-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'security-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group"
      },
      "value": "[variables('resourceGroupName')]"
    },
    "vnetName": {
      "type": "string",
      "metadata": {
        "description": "The name of the virtual network"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetName.value]"
    },
    "appSubnetId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the app subnet"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.appSubnetId.value]"
    },
    "vmPrivateIpAddress": {
      "type": "string",
      "metadata": {
        "description": "The private IP address of the CloudPi VM"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'compute-deployment'), '2025-04-01').outputs.vmPrivateIpAddress.value]"
    },
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "The name of the CloudPi VM"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'compute-deployment'), '2025-04-01').outputs.vmName.value]"
    },
    "vmManagedIdentityPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the VM managed identity"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'compute-deployment'), '2025-04-01').outputs.vmManagedIdentityPrincipalId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the storage account"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "The URI of the Key Vault"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the Log Analytics workspace"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "recoveryServicesVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Recovery Services Vault (if backup is enabled)"
      },
      "value": "[if(parameters('enableBackup'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.recoveryServicesVaultName.value, '')]"
    }
  }
}